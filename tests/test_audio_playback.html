<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Playback Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽµ Audio Playback Test</h1>
        <p>This test simulates the <code>tts_audio_chunk</code> event to verify frontend audio playback functionality.</p>
        
        <div id="status" class="status info">Ready to test audio playback</div>
        
        <div>
            <button id="testAudio" onclick="testAudioPlayback()">Test Audio Playback</button>
            <button id="testWebSocket" onclick="testWebSocketAudio()">Test WebSocket Audio</button>
            <button id="clearLog" onclick="clearLog()">Clear Log</button>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        let audioContext = null;
        let audioQueue = [];
        let isPlaying = false;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // Audio playback using Web Audio API (same as frontend)
        async function playNextAudioChunk() {
            if (isPlaying || audioQueue.length === 0) {
                return;
            }

            isPlaying = true;
            log('Starting audio playback...');
            
            try {
                if (!audioContext) {
                    audioContext = new AudioContext();
                    log('Created new AudioContext');
                }

                const audioData = audioQueue.shift();
                log(`Decoding audio data of size: ${audioData.byteLength} bytes`);
                
                const audioBuffer = await audioContext.decodeAudioData(audioData);
                log(`Audio decoded successfully, duration: ${audioBuffer.duration.toFixed(2)}s`);
                
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);
                
                source.onended = () => {
                    log('Audio chunk finished playing');
                    isPlaying = false;
                    // Play next chunk if available
                    if (audioQueue.length > 0) {
                        playNextAudioChunk();
                    } else {
                        log('Audio queue empty, playback complete');
                        updateStatus('Audio playback completed successfully!', 'success');
                    }
                };
                
                source.start();
                log('Audio source started');
                
            } catch (error) {
                log(`Error playing audio: ${error.message}`);
                isPlaying = false;
                updateStatus(`Audio playback error: ${error.message}`, 'error');
            }
        }

        // Simulate tts_audio_chunk event with test audio
        async function testAudioPlayback() {
            updateStatus('Testing audio playback...', 'info');
            log('=== Starting Audio Playback Test ===');
            
            try {
                // Create a simple test audio (1 second sine wave at 440Hz)
                if (!audioContext) {
                    audioContext = new AudioContext();
                }
                
                const sampleRate = audioContext.sampleRate;
                const duration = 1; // 1 second
                const frequency = 440; // A4 note
                const numSamples = sampleRate * duration;
                
                const audioBuffer = audioContext.createBuffer(1, numSamples, sampleRate);
                const channelData = audioBuffer.getChannelData(0);
                
                for (let i = 0; i < numSamples; i++) {
                    channelData[i] = Math.sin(2 * Math.PI * frequency * i / sampleRate) * 0.3;
                }
                
                log(`Generated test audio: ${duration}s sine wave at ${frequency}Hz`);
                
                // Convert to ArrayBuffer
                const arrayBuffer = audioBuffer.getChannelData(0).buffer;
                log(`Audio buffer size: ${arrayBuffer.byteLength} bytes`);
                
                // Add to queue and play
                audioQueue.push(arrayBuffer);
                await playNextAudioChunk();
                
            } catch (error) {
                log(`Error in audio test: ${error.message}`);
                updateStatus(`Test failed: ${error.message}`, 'error');
            }
        }

        // Test WebSocket audio (simulate the actual event)
        async function testWebSocketAudio() {
            updateStatus('Testing WebSocket audio simulation...', 'info');
            log('=== Starting WebSocket Audio Test ===');
            
            try {
                // Simulate the tts_audio_chunk event
                const mockTtsAudioChunk = {
                    event: 'tts_audio_chunk',
                    audio_data: 'UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT',
                    session_id: 'test_session_audio',
                    timestamp: new Date().toISOString()
                };
                
                log('Simulating tts_audio_chunk event...');
                log(`Event data: ${JSON.stringify(mockTtsAudioChunk, null, 2)}`);
                
                // Process the event like the frontend would
                if (mockTtsAudioChunk.audio_data) {
                    log('Decoding base64 audio data...');
                    const audioData = Uint8Array.from(atob(mockTtsAudioChunk.audio_data), c => c.charCodeAt(0));
                    log(`Decoded audio size: ${audioData.byteLength} bytes`);
                    
                    audioQueue.push(audioData.buffer);
                    await playNextAudioChunk();
                }
                
            } catch (error) {
                log(`Error in WebSocket audio test: ${error.message}`);
                updateStatus(`WebSocket test failed: ${error.message}`, 'error');
            }
        }

        // Initialize
        log('Audio Playback Test initialized');
        log('Click "Test Audio Playback" to test basic audio functionality');
        log('Click "Test WebSocket Audio" to simulate the actual tts_audio_chunk event');
    </script>
</body>
</html> 